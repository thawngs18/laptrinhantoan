<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Demo OTP Firebase Modular</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        max-width: 400px;
        margin: 0 auto;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h2 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
      }
      input {
        margin: 5px 0;
        padding: 12px;
        width: 100%;
        box-sizing: border-box;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s;
      }
      input:focus {
        outline: none;
        border-color: #007bff;
      }
      input.error {
        border-color: #dc3545;
      }
      button {
        padding: 12px 20px;
        margin: 8px 4px 8px 0;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
        min-width: 100px;
      }
      button:hover:not(:disabled) {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .btn-secondary {
        background-color: #6c757d;
      }
      .btn-secondary:hover {
        background-color: #545b62;
      }
      .btn-success {
        background-color: #28a745;
      }
      .btn-success:hover {
        background-color: #218838;
      }
      #status {
        font-weight: bold;
        margin-top: 15px;
        padding: 12px;
        border-radius: 8px;
        display: none;
        text-align: center;
      }
      .status-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .phone-container {
        position: relative;
      }
      .phone-format {
        font-size: 14px;
        color: #666;
        margin-bottom: 10px;
        font-style: italic;
      }
      .security-info {
        font-size: 12px;
        color: #666;
        margin-top: 8px;
        text-align: center;
        font-style: italic;
      }
      .section {
        margin-bottom: 25px;
        padding: 20px;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        transition: all 0.3s ease;
      }
      .section.active {
        border-color: #007bff;
        background-color: #f8f9fa;
      }
      .otp-section {
        display: none;
        animation: slideDown 0.3s ease-out;
      }
      .otp-section.show {
        display: block;
      }
      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        position: relative;
      }
      .step {
        flex: 1;
        text-align: center;
        position: relative;
        color: #6c757d;
      }
      .step.active {
        color: #007bff;
        font-weight: bold;
      }
      .step.completed {
        color: #28a745;
      }
      .step::before {
        content: "";
        position: absolute;
        top: 20px;
        left: 0;
        right: 0;
        height: 2px;
        background-color: #e9ecef;
        z-index: -1;
      }
      .step:first-child::before {
        left: 50%;
      }
      .step:last-child::before {
        right: 50%;
      }
      .step-icon {
        width: 30px;
        height: 30px;
        border: 2px solid #e9ecef;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 5px;
        background: white;
        transition: all 0.3s;
      }
      .step.active .step-icon {
        border-color: #007bff;
        background-color: #007bff;
        color: white;
      }
      .step.completed .step-icon {
        border-color: #28a745;
        background-color: #28a745;
        color: white;
      }
      .phone-display {
        color: #007bff;
        font-weight: bold;
        margin-top: 5px;
      }
      .invisible-recaptcha {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
        visibility: visible;
        opacity: 0;
      }

      /* Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }
      .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 25px;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      }
      .modal h3 {
        margin-bottom: 20px;
        color: #333;
        text-align: center;
        font-size: 20px;
      }
      .modal label {
        display: block;
        margin-bottom: 5px;
        color: #333;
        font-weight: 500;
      }
      .modal input {
        margin-bottom: 15px;
      }
      .modal input.error {
        border-color: #dc3545;
      }
      .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
      }
      .modal-status {
        margin-top: 15px;
        padding: 10px;
        border-radius: 8px;
        display: none;
        text-align: center;
        font-size: 14px;
        font-weight: 500;
      }
      .status-success-modal {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status-error-modal {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .register-link {
        text-align: center;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e9ecef;
      }
      .register-link a {
        color: #007bff;
        text-decoration: none;
        font-weight: 500;
        font-size: 14px;
        cursor: pointer;
      }
      .register-link a:hover {
        text-decoration: underline;
      }
      .error-message {
        color: #dc3545;
        font-size: 12px;
        margin-top: 5px;
        display: none;
        text-align: center;
      }
      .error-message.show {
        display: block;
      }
      .loading {
        text-align: center;
        color: #007bff;
        font-size: 14px;
        margin-top: 10px;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>X√°c th·ª±c OTP</h2>

      <!-- Step Indicator -->
      <div class="step-indicator">
        <div class="step step-1 active">
          <div class="step-icon">1</div>
          <div>Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i</div>
        </div>
        <div class="step step-2">
          <div class="step-icon">2</div>
          <div>Nh·∫≠p m√£ OTP</div>
        </div>
      </div>

      <!-- Phone Section -->
      <div class="section phone-section active">
        <div class="phone-format">üì± Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i</div>
        <div class="phone-container">
          <input
            type="tel"
            id="phone"
            placeholder="0123456789"
            maxlength="10"
          />
          <div id="phone-error" class="error-message"></div>
          <button id="send-btn" onclick="sendOTP()">G·ª≠i OTP</button>
          <div id="loading-check" class="loading">ƒêang ki·ªÉm tra...</div>
        </div>

        <!-- Invisible reCAPTCHA container -->
        <div id="recaptcha-container" class="invisible-recaptcha"></div>

        <div class="security-info">X√°c minh b·∫£o m·∫≠t t·ª± ƒë·ªông...</div>

        <!-- Registration Link -->
        <div class="register-link">
          <a
            href="#"
            id="register-link"
            onclick="showRegisterModal(); return false;"
          >
            üìù Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω ngay
          </a>
        </div>
      </div>

      <!-- OTP Section (Hidden initially) -->
      <div class="section otp-section">
        <div class="phone-format">
          üì® M√£ OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn
          <div id="display-phone" class="phone-display"></div>
        </div>
        <input
          type="text"
          id="otp"
          placeholder="Nh·∫≠p m√£ OTP (6 ch·ªØ s·ªë)"
          maxlength="6"
        />
        <div style="margin-top: 15px; display: flex; gap: 10px">
          <button id="verify-btn" onclick="verifyOTP()" style="flex: 2">
            X√°c th·ª±c OTP
          </button>
          <button
            id="resend-btn"
            class="btn-secondary"
            onclick="resendOTP()"
            style="flex: 1"
          >
            G·ª≠i l·∫°i
          </button>
        </div>
      </div>

      <!-- Status -->
      <div id="status"></div>
    </div>

    <!-- Registration Modal -->
    <div id="registerModal" class="modal">
      <div class="modal-content">
        <h3>üìù ƒêƒÉng k√Ω t√†i kho·∫£n</h3>

        <div>
          <label for="regName">H·ªç v√† t√™n:</label>
          <input
            type="text"
            id="regName"
            placeholder="Nh·∫≠p h·ªç v√† t√™n ƒë·∫ßy ƒë·ªß"
            maxlength="100"
          />
        </div>

        <div>
          <label for="regPhone">S·ªë ƒëi·ªán tho·∫°i:</label>
          <input
            type="tel"
            id="regPhone"
            placeholder="0123456789"
            maxlength="10"
          />
        </div>

        <div class="modal-buttons">
          <button
            id="regSubmitBtn"
            onclick="registerUser()"
            class="btn-success"
          >
            ƒêƒÉng k√Ω
          </button>
          <button onclick="closeRegisterModal()" class="btn-secondary">
            H·ªßy
          </button>
        </div>

        <div id="regStatus" class="modal-status"></div>
      </div>
    </div>

    <script type="module">
      // Import Firebase modular SDK
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
      import {
        getAuth,
        RecaptchaVerifier,
        signInWithPhoneNumber,
      } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

      // Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyDNMHPv3nq6zY4odZkwWINBt-m_3Q_2qMA",
        authDomain: "otpauth-39f8d.firebaseapp.com",
        projectId: "otpauth-39f8d",
        storageBucket: "otpauth-39f8d.firebasestorage.app",
        messagingSenderId: "1008987088231",
        appId: "1:1008987088231:web:0424a27d8d80e1ec9c7bc2",
        measurementId: "G-GJF5W4TWB7",
      };

      // Init Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      // ReCAPTCHA - invisible mode
      let recaptchaVerifier = null;

      let confirmationResultGlobal = null;
      let formattedPhoneNumber = null;
      let currentPhoneNumber = null;

      // State management
      const state = {
        currentStep: 1, // 1: phone, 2: otp
        isPhoneSent: false,
        phoneNumber: "",
        isRegistered: false,
      };

      // DOM elements
      const elements = {
        phoneSection: document.querySelector(".phone-section"),
        otpSection: document.querySelector(".otp-section"),
        step1: document.querySelector(".step-1"),
        step2: document.querySelector(".step-2"),
        phoneInput: document.getElementById("phone"),
        otpInput: document.getElementById("otp"),
        sendBtn: document.getElementById("send-btn"),
        verifyBtn: document.getElementById("verify-btn"),
        resendBtn: document.getElementById("resend-btn"),
        status: document.getElementById("status"),
        displayPhone: document.getElementById("display-phone"),
        recaptchaContainer: document.getElementById("recaptcha-container"),
        phoneError: document.getElementById("phone-error"),
        loadingCheck: document.getElementById("loading-check"),
      };

      // Error handling functions
      function showError(elementId, message) {
        const errorEl = document.getElementById(elementId);
        if (errorEl) {
          errorEl.textContent = message;
          errorEl.classList.add("show");
        }
        if (elementId === "phone-error") {
          showStatus(message, "error");
        }
      }

      function hideError(elementId) {
        const errorEl = document.getElementById(elementId);
        if (errorEl) {
          errorEl.classList.remove("show");
        }
      }

      // Show/hide loading
      function showLoading(show = true) {
        elements.loadingCheck.style.display = show ? "block" : "none";
      }

      // H√†m kh·ªüi t·∫°o invisible reCAPTCHA
      function initInvisibleRecaptcha() {
        if (recaptchaVerifier) {
          recaptchaVerifier.clear();
        }

        recaptchaVerifier = new RecaptchaVerifier(
          "recaptcha-container",
          {
            size: "invisible",
            callback: (response) => {
              console.log("reCAPTCHA verified automatically!");
            },
            "expired-callback": () => {
              showStatus(
                "X√°c minh b·∫£o m·∫≠t h·∫øt h·∫°n, vui l√≤ng th·ª≠ l·∫°i.",
                "error"
              );
              elements.sendBtn.disabled = true;
            },
            "error-callback": (error) => {
              console.error("reCAPTCHA error:", error);
              showStatus("L·ªói x√°c minh b·∫£o m·∫≠t, vui l√≤ng th·ª≠ l·∫°i.", "error");
              elements.sendBtn.disabled = true;
            },
          },
          auth
        );

        // Enable send button sau khi reCAPTCHA load
        setTimeout(() => {
          elements.sendBtn.disabled = false;
          console.log("reCAPTCHA loaded, button enabled");
        }, 1000);
      }

      // H√†m reset reCAPTCHA
      function resetRecaptcha() {
        if (recaptchaVerifier && recaptchaVerifier.render) {
          recaptchaVerifier.render().catch((error) => {
            console.error("Error resetting reCAPTCHA:", error);
          });
        }
      }

      // H√†m format s·ªë ƒëi·ªán tho·∫°i
      function formatPhoneNumber(phone) {
        const cleanPhone = phone.replace(/\D/g, "");

        if (cleanPhone.startsWith("0") && cleanPhone.length === 10) {
          return "+84" + cleanPhone.substring(1);
        }

        if (cleanPhone.startsWith("84") && cleanPhone.length === 11) {
          return "+" + cleanPhone;
        }

        if (cleanPhone.startsWith("+84") && cleanPhone.length === 12) {
          return cleanPhone;
        }

        return phone;
      }

      // H√†m ki·ªÉm tra s·ªë ƒëi·ªán tho·∫°i h·ª£p l·ªá
      function isValidPhone(phone) {
        const cleanPhone = phone.replace(/\D/g, "");
        const formatted = formatPhoneNumber(phone);
        const vietnamPattern = /^\+84\d{9}$/;
        return vietnamPattern.test(formatted);
      }

      // Check if phone is registered
      async function checkPhoneRegistered(phone) {
        try {
          const response = await fetch("/send-otp", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ phone: phone }),
          });

          const data = await response.json();
          return data.success;
        } catch (error) {
          console.error("Error checking registration:", error);
          return false;
        }
      }

      // H√†m hi·ªÉn th·ªã status
      function showStatus(message, type, duration = 5000) {
        const statusDiv = elements.status;
        statusDiv.textContent = message;
        statusDiv.className = `status-${type}`;
        statusDiv.style.display = "block";

        if (duration > 0) {
          setTimeout(() => {
            statusDiv.style.display = "none";
          }, duration);
        }
      }

      // H√†m c·∫≠p nh·∫≠t step indicator
      function updateStepIndicator(step) {
        document.querySelectorAll(".step").forEach((s) => {
          s.classList.remove("active", "completed");
        });

        for (let i = 1; i <= 2; i++) {
          const stepEl = document.querySelector(`.step-${i}`);
          if (i < step) {
            stepEl.classList.add("completed");
          } else if (i === step) {
            stepEl.classList.add("active");
          }
        }
      }

      // H√†m hi·ªÉn th·ªã OTP section
      function showOTPSection(phoneNumber) {
        state.currentStep = 2;
        state.isPhoneSent = true;
        state.phoneNumber = phoneNumber;
        currentPhoneNumber = phoneNumber;

        elements.phoneSection.style.display = "none";
        elements.otpSection.classList.add("show");
        elements.displayPhone.textContent = phoneNumber;
        updateStepIndicator(2);

        elements.otpInput.focus();

        showStatus(`üì® OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn ${phoneNumber}`, "success", 4000);
      }

      // H√†m ·∫©n OTP section v√† reset
      function hideOTPSection() {
        state.currentStep = 1;
        state.isPhoneSent = false;
        state.phoneNumber = "";
        currentPhoneNumber = null;

        elements.phoneSection.style.display = "block";
        elements.otpSection.classList.remove("show");
        updateStepIndicator(1);

        elements.phoneInput.value = "";
        elements.otpInput.value = "";
        hideError("phone-error");

        elements.status.style.display = "none";

        elements.phoneInput.focus();

        setTimeout(() => {
          resetRecaptcha();
        }, 500);
      }

      // G·ª≠i OTP v·ªõi ki·ªÉm tra ƒëƒÉng k√Ω tr∆∞·ªõc
      window.sendOTP = async () => {
        let phoneNumber = elements.phoneInput.value.trim();

        hideError("phone-error");
        showLoading(false);

        if (!phoneNumber) {
          showError("phone-error", "Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i!");
          elements.phoneInput.focus();
          return;
        }

        formattedPhoneNumber = formatPhoneNumber(phoneNumber);

        if (!isValidPhone(formattedPhoneNumber)) {
          showError(
            "phone-error",
            "S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá! (10 s·ªë, b·∫Øt ƒë·∫ßu b·∫±ng 0)"
          );
          elements.phoneInput.focus();
          return;
        }

        // Ki·ªÉm tra ƒëƒÉng k√Ω tr∆∞·ªõc khi g·ª≠i OTP
        elements.sendBtn.disabled = true;
        elements.sendBtn.textContent = "ƒêang ki·ªÉm tra...";
        showLoading(true);
        elements.status.style.display = "none";

        try {
          const isUserRegistered = await checkPhoneRegistered(phoneNumber);

          if (!isUserRegistered) {
            elements.sendBtn.disabled = false;
            elements.sendBtn.textContent = "G·ª≠i OTP";
            showLoading(false);

            if (
              confirm(
                `S·ªë ƒëi·ªán tho·∫°i ${phoneNumber} ch∆∞a ƒë∆∞·ª£c ƒëƒÉng k√Ω. B·∫°n c√≥ mu·ªën ƒëƒÉng k√Ω kh√¥ng?`
              )
            ) {
              document.getElementById("regPhone").value = phoneNumber;
              showRegisterModal();
            }
            return;
          }

          // User ƒë√£ ƒëƒÉng k√Ω, ti·∫øp t·ª•c g·ª≠i OTP
          elements.sendBtn.textContent = "ƒêang g·ª≠i OTP...";
          showLoading(false);

          if (!recaptchaVerifier) {
            showStatus("ƒêang kh·ªüi t·∫°o b·∫£o m·∫≠t, vui l√≤ng ch·ªù...", "error");
            elements.sendBtn.disabled = false;
            elements.sendBtn.textContent = "G·ª≠i OTP";
            return;
          }

          const confirmationResult = await signInWithPhoneNumber(
            auth,
            formattedPhoneNumber,
            recaptchaVerifier
          );

          confirmationResultGlobal = confirmationResult;

          showOTPSection(phoneNumber);

          console.log("OTP sent successfully:", confirmationResult);
        } catch (error) {
          console.error("L·ªói g·ª≠i OTP:", error);
          let errorMessage = "L·ªói g·ª≠i OTP: ";

          switch (error.code) {
            case "auth/invalid-phone-number":
              errorMessage += "S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá";
              break;
            case "auth/too-many-requests":
              errorMessage += "Qu√° nhi·ªÅu y√™u c·∫ßu, vui l√≤ng th·ª≠ l·∫°i sau 1 ph√∫t";
              break;
            case "auth/quota-exceeded":
              errorMessage += "ƒê√£ v∆∞·ª£t qu√° gi·ªõi h·∫°n, vui l√≤ng th·ª≠ l·∫°i sau";
              break;
            case "auth/captcha-check-failed":
              errorMessage += "X√°c minh b·∫£o m·∫≠t th·∫•t b·∫°i, vui l√≤ng th·ª≠ l·∫°i";
              resetRecaptcha();
              break;
            case "auth/missing-recaptcha-token":
              errorMessage += "Kh√¥ng th·ªÉ x√°c minh b·∫£o m·∫≠t, vui l√≤ng th·ª≠ l·∫°i";
              resetRecaptcha();
              break;
            default:
              errorMessage += error.message;
          }

          showStatus(errorMessage, "error");
        } finally {
          elements.sendBtn.disabled = false;
          elements.sendBtn.textContent = "G·ª≠i OTP";
          showLoading(false);
        }
      };

      // X√°c th·ª±c OTP
      window.verifyOTP = () => {
        const code = elements.otpInput.value.trim();

        if (!code) {
          showStatus("Vui l√≤ng nh·∫≠p m√£ OTP!", "error");
          elements.otpInput.focus();
          return;
        }

        if (code.length !== 6) {
          showStatus("M√£ OTP ph·∫£i c√≥ 6 ch·ªØ s·ªë!", "error");
          elements.otpInput.focus();
          return;
        }

        if (!confirmationResultGlobal) {
          showStatus(
            "Phi√™n x√°c th·ª±c ƒë√£ h·∫øt h·∫°n, vui l√≤ng g·ª≠i l·∫°i OTP!",
            "error"
          );
          hideOTPSection();
          return;
        }

        elements.verifyBtn.disabled = true;
        elements.verifyBtn.textContent = "ƒêang x√°c th·ª±c...";
        elements.status.style.display = "none";

        confirmationResultGlobal
          .confirm(code)
          .then((result) => {
            showStatus(
              `üéâ X√°c th·ª±c th√†nh c√¥ng! ƒêang chuy·ªÉn ti·∫øp...`,
              "success",
              700
            );
            console.log("Verification success:", result.user);

            elements.verifyBtn.disabled = true;
            elements.resendBtn.disabled = true;

            elements.otpInput.value = "";

            setTimeout(() => {
              window.location.href = "/welcome";
            }, 700);
          })
          .catch((error) => {
            console.error("Verification failed:", error);
            let errorMessage = "";

            switch (error.code) {
              case "auth/invalid-verification-code":
                errorMessage = "‚ùå M√£ OTP kh√¥ng ƒë√∫ng, vui l√≤ng ki·ªÉm tra l·∫°i!";
                break;
              case "auth/code-expired":
                errorMessage = "‚è∞ M√£ OTP ƒë√£ h·∫øt h·∫°n, vui l√≤ng g·ª≠i l·∫°i!";
                hideOTPSection();
                break;
              case "auth/session-expired":
                errorMessage =
                  "‚è∞ Phi√™n x√°c th·ª±c ƒë√£ h·∫øt h·∫°n, vui l√≤ng g·ª≠i l·∫°i OTP!";
                hideOTPSection();
                break;
              case "auth/too-many-requests":
                errorMessage =
                  "‚ö†Ô∏è Qu√° nhi·ªÅu l·∫ßn th·ª≠ sai, vui l√≤ng g·ª≠i l·∫°i OTP sau 1 ph√∫t";
                break;
              case "auth/missing-verification-code":
                errorMessage = "‚ùå Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß m√£ OTP!";
                break;
              default:
                errorMessage = `‚ùå L·ªói: ${error.message}`;
            }

            showStatus(errorMessage, "error");
            elements.otpInput.value = "";
            elements.otpInput.focus();
          })
          .finally(() => {
            elements.verifyBtn.disabled = false;
            elements.verifyBtn.textContent = "X√°c th·ª±c OTP";
          });
      };

      // G·ª≠i l·∫°i OTP
      window.resendOTP = () => {
        elements.otpInput.value = "";
        elements.status.style.display = "none";
        elements.verifyBtn.disabled = false;
        elements.verifyBtn.textContent = "X√°c th·ª±c OTP";
        elements.resendBtn.className = "btn-secondary";
        elements.resendBtn.textContent = "G·ª≠i l·∫°i";
        elements.resendBtn.disabled = false;

        hideOTPSection();
      };

      // ===== REGISTRATION FUNCTIONS - GLOBAL SCOPE =====
      window.showRegisterModal = function () {
        document.getElementById("registerModal").style.display = "block";
        const regNameInput = document.getElementById("regName");
        const regPhoneInput = document.getElementById("regPhone");

        document.getElementById("regName").classList.remove("error");
        document.getElementById("regPhone").classList.remove("error");
        document.getElementById("regStatus").style.display = "none";

        regNameInput.focus();
      };

      window.closeRegisterModal = function () {
        document.getElementById("registerModal").style.display = "none";
        document.getElementById("regName").value = "";
        document.getElementById("regPhone").value = "";
        document.getElementById("regName").classList.remove("error");
        document.getElementById("regPhone").classList.remove("error");
        document.getElementById("regStatus").style.display = "none";
      };

      window.showRegStatus = function (message, type) {
        const statusDiv = document.getElementById("regStatus");
        statusDiv.textContent = message;

        if (type === "success") {
          statusDiv.className = "modal-status status-success-modal";
        } else {
          statusDiv.className = "modal-status status-error-modal";
        }

        statusDiv.style.display = "block";
      };

      window.showRegInputError = function (inputId, message) {
        const input = document.getElementById(inputId);
        input.classList.add("error");
        showRegStatus(message, "error");
      };

      window.registerUser = async function () {
        const name = document.getElementById("regName").value.trim();
        const phone = document.getElementById("regPhone").value.trim();
        const statusDiv = document.getElementById("regStatus");
        const submitBtn = document.getElementById("regSubmitBtn");

        document.getElementById("regName").classList.remove("error");
        document.getElementById("regPhone").classList.remove("error");
        statusDiv.style.display = "none";

        if (!name || name.length < 2) {
          showRegInputError(
            "regName",
            "Vui l√≤ng nh·∫≠p h·ªç v√† t√™n (√≠t nh·∫•t 2 k√Ω t·ª±)"
          );
          return;
        }

        if (!phone || phone.length !== 10 || !phone.startsWith("0")) {
          showRegInputError(
            "regPhone",
            "Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i h·ª£p l·ªá (10 s·ªë, b·∫Øt ƒë·∫ßu b·∫±ng 0)"
          );
          return;
        }

        const validPrefixes = ["03", "05", "07", "08", "09"];
        const prefix = phone.substring(0, 2);
        if (!validPrefixes.includes(prefix)) {
          showRegInputError("regPhone", "S·ªë ƒëi·ªán tho·∫°i kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng");
          return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = "ƒêang ƒëƒÉng k√Ω...";
        statusDiv.style.display = "none";

        try {
          const response = await fetch("/register", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ name, phone }),
          });

          const result = await response.json();

          if (result.success) {
            showRegStatus(
              "‚úÖ ƒêƒÉng k√Ω th√†nh c√¥ng! B·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng s·ªë ƒëi·ªán tho·∫°i ƒë·ªÉ x√°c th·ª±c.",
              "success"
            );

            state.isRegistered = true;

            elements.phoneInput.value = phone;

            setTimeout(() => {
              closeRegisterModal();
              sendOTP();
            }, 2000);
          } else {
            showRegStatus(result.message, "error");
            if (result.message.includes("ƒë√£ ƒë∆∞·ª£c ƒëƒÉng k√Ω")) {
              elements.phoneInput.value = phone;
              setTimeout(() => {
                closeRegisterModal();
                sendOTP();
              }, 1500);
            }
          }
        } catch (error) {
          console.error("Registration error:", error);
          showRegStatus("C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.", "error");
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = "ƒêƒÉng k√Ω";
        }
      };

      // Event listeners
      document.addEventListener("DOMContentLoaded", () => {
        // Kh·ªüi t·∫°o invisible reCAPTCHA
        initInvisibleRecaptcha();

        // Auto-format phone number
        elements.phoneInput.addEventListener("input", (e) => {
          let value = e.target.value.replace(/\D/g, "");

          if (value.startsWith("0")) {
            // Gi·ªØ nguy√™n
          } else if (value.length > 0) {
            value = "0" + value;
          }

          if (value.length > 10) {
            value = value.substring(0, 10);
          }

          e.target.value = value;
        });

        // Auto-format OTP
        elements.otpInput.addEventListener("input", (e) => {
          e.target.value = e.target.value.replace(/\D/g, "").substring(0, 6);
        });

        // Enter key support
        elements.phoneInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            sendOTP();
          }
        });

        elements.otpInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            verifyOTP();
          }
        });

        // Initial focus
        elements.phoneInput.focus();

        // Initial step indicator
        updateStepIndicator(1);

        // Auto-format phone input in registration modal
        const regPhoneInput = document.getElementById("regPhone");
        if (regPhoneInput) {
          regPhoneInput.addEventListener("input", function (e) {
            let value = e.target.value.replace(/\D/g, "");
            if (value.length > 0 && !value.startsWith("0")) {
              value = "0" + value;
            }
            if (value.length > 10) {
              value = value.substring(0, 10);
            }
            e.target.value = value;
          });
        }

        // Close modal when clicking outside
        window.onclick = function (event) {
          const modal = document.getElementById("registerModal");
          if (event.target == modal) {
            closeRegisterModal();
          }
        };
      });
    </script>
  </body>
</html>
